# UAT Story Evaluation: master vs v6.6.1

**Date**: 2026-02-15
**Agent**: Gemini (gemini-3-flash-preview)
**Stories**: 12 (s01-s12)
**Method**: Each story run against a fresh HA Docker container via MCP

---

## Executive Summary

| Metric | v6.6.1 | master | Delta |
|--------|--------|--------|-------|
| **Success rate** | 11/12 (92%) | **12/12 (100%)** | +1 story |
| **Total time** | 1,042.7s | **807.2s** | -22.6% |
| **Billable tokens** | 557,498 | **536,601** | -3.7% |
| **Tool count** | 91 | 92 | +1 |
| **Tool description size** | 134,449 chars | 137,661 chars | +2.4% |

**master is better across all key metrics**: higher success, faster execution, lower token cost. The small increase in tool description size (+2.4%) is a worthwhile trade-off.

---

## Success Rate

| Story | Category | Weight | v6.6.1 | master |
|-------|----------|--------|--------|--------|
| s01 | automation | 5 | PASS | PASS |
| s02 | automation | 5 | PASS | PASS |
| s03 | troubleshoot | 5 | PASS | PASS |
| s04 | dashboard | 4 | PASS | PASS |
| s05 | entity | 4 | PASS | PASS |
| s06 | script | 4 | PASS | PASS |
| s07 | automation | 4 | PASS | PASS |
| s08 | automation | 4 | PASS | PASS |
| s09 | helper | 3 | **FAIL** | PASS |
| s10 | organization | 3 | PASS | PASS |
| s11 | troubleshoot | 3 | PASS | PASS |
| s12 | organization | 3 | PASS | PASS |

**s09 (helper creation)**: Failed on v6.6.1 (0 tool calls, likely prompt/tool mismatch), passed on master (7 calls, 1 failure recovered).

---

## Performance (Wall Time)

| Story | v6.6.1 (s) | master (s) | Delta | % |
|-------|-----------|-----------|-------|---|
| s01 | 118.1 | 80.3 | -37.8 | -32% |
| s02 | 77.0 | 122.3 | +45.3 | +59% |
| s03 | 58.9 | 61.6 | +2.7 | +5% |
| s04 | 55.4 | 57.8 | +2.4 | +4% |
| s05 | 69.1 | 63.4 | -5.7 | -8% |
| s06 | 58.6 | 48.8 | -9.8 | -17% |
| s07 | 47.5 | 47.5 | 0.0 | 0% |
| s08 | 79.6 | 59.2 | -20.4 | -26% |
| s09 | 106.8 | 59.3 | -47.5 | -44% |
| s10 | 60.8 | 48.5 | -12.3 | -20% |
| s11 | 193.0 | 116.2 | -76.8 | -40% |
| s12 | 117.8 | 42.1 | -75.7 | -64% |
| **Total** | **1,042.7** | **807.2** | **-235.5** | **-22.6%** |

10 of 12 stories are faster or equal on master. Only s02 and s03 are slower (see S02 Investigation below).

---

## Token Efficiency

Billable tokens = non-cached input + output + thoughts. Cached tokens are free and excluded.

| Story | v6.6.1 billable | master billable | Delta | % |
|-------|----------------|----------------|-------|---|
| s01 | 36,262 | 64,037 | +27,775 | +77% |
| s02 | 44,679 | 77,111 | +32,432 | +73% |
| s03 | 34,559 | 37,537 | +2,978 | +9% |
| s04 | 37,537 | 38,477 | +940 | +3% |
| s05 | 91,021 | 46,898 | -44,123 | -48% |
| s06 | 36,379 | 34,275 | -2,104 | -6% |
| s07 | 33,208 | 32,207 | -1,001 | -3% |
| s08 | 41,184 | 40,197 | -987 | -2% |
| s09 | 71,889 | 39,775 | -32,114 | -45% |
| s10 | 38,017 | 33,194 | -4,823 | -13% |
| s11 | 60,241 | 62,462 | +2,221 | +4% |
| s12 | 32,522 | 30,431 | -2,091 | -6% |
| **Total** | **557,498** | **536,601** | **-20,897** | **-3.7%** |

Net: master is 3.7% cheaper in billable tokens despite the higher s02 cost.

---

## Tool Description Size

master adds 1 new tool and modifies 12 existing tools. Net impact: +3,212 chars (+2.4%).

### Summary

| Metric | v6.6.1 | master | Delta | % |
|--------|--------|--------|-------|---|
| Total tools | 91 | 92 | +1 | |
| Description chars | 86,405 | 87,632 | +1,227 | +1.4% |
| Schema chars | 48,044 | 50,029 | +1,985 | +4.1% |
| **Combined chars** | **134,449** | **137,661** | **+3,212** | **+2.4%** |
| Avg chars/tool | 1,477 | 1,496 | +19 | +1.3% |

### New Tool

| Tool | Desc | Schema | Total |
|------|------|--------|-------|
| `ha_get_states` | 826 | 232 | 1,058 |

### Changed Tools (12 of 91 common)

| Tool | v6.6.1 | master | Delta | Desc +/- | Schema +/- |
|------|--------|--------|-------|----------|------------|
| `ha_call_service` | 1,789 | 2,123 | +334 | +255 | +79 |
| `ha_deep_search` | 1,642 | 1,881 | +239 | +0 | +239 |
| `ha_hacs_search` | 1,429 | 1,645 | +216 | +66 | +150 |
| `ha_config_set_helper` | 7,630 | 7,833 | +203 | +0 | +203 |
| `ha_config_set_automation` | 5,146 | 5,346 | +200 | +0 | +200 |
| `ha_config_set_script` | 4,185 | 4,381 | +196 | +0 | +196 |
| `ha_config_remove_helper` | 1,118 | 1,291 | +173 | +0 | +173 |
| `ha_config_remove_automation` | 485 | 655 | +170 | +0 | +170 |
| `ha_config_remove_script` | 755 | 921 | +166 | +0 | +166 |
| `ha_search_entities` | 1,483 | 1,633 | +150 | +0 | +150 |
| `ha_config_set_dashboard` | 8,152 | 8,284 | +132 | +80 | +52 |
| `ha_get_overview` | 1,285 | 1,260 | -25 | +0 | -25 |

79 tools unchanged.

**Pattern**: Most schema growth comes from the new `wait` parameter added to config/remove tools (automations, helpers, scripts). Description growth is primarily in `ha_call_service` (+255 chars). Only `ha_get_overview` shrank slightly.

---

## Possible Regression: S02 Investigation

S02 ("motion-activated kitchen light automation") was 59% slower on master (122.3s vs 77.0s) and 73% more expensive in tokens (77,111 vs 44,679 billable). This section investigates whether this is a code regression or noise.

### Root Cause: Gemini KV-Cache Miss

| Metric | v6.6.1 | master |
|--------|--------|--------|
| Session time (from timestamps) | 37.1s | 89.3s |
| Gemini turns | 8 | 10 |
| Tool calls | 8 | 9 |

**Turn-by-turn timing** reveals the smoking gun:

| Turn | v6.6.1 | master |
|------|--------|--------|
| T1 | 4.3s (cached=0) | 6.1s (cached=0) |
| T2 | 4.1s (cached=25,752) | **43.2s (cached=0)** |
| T3 | 4.0s (cached=28,528) | 6.4s (cached=28,143) |
| T4+ | ~2-8s each (cached) | ~3-5s each (cached) |

**Turn 2 on master had a full cache miss** (cached=0), forcing Gemini to recompute all 29,096 input tokens from scratch instead of reusing the ~25k cached tokens from Turn 1. This single turn accounts for **75% of the total slowdown** (~39s of the 52s gap).

### Why the Cache Miss

- **v6.6.1 Turn 1** used `ha_get_state` (two parallel calls) to check entities
- **master Turn 1** used `ha_get_states` (one batch call with different response structure)

The different tool name and response shape changed the conversation prefix enough to invalidate Gemini's KV-cache between Turn 1 and Turn 2. After Turn 2, caching resumed normally (~28-31k cached tokens per turn).

### Additional Contributing Factors

master made 3 extra tool calls not present in v6.6.1:

| Extra Tool | Time | Purpose |
|-----------|------|---------|
| `ha_config_list_helpers` | 4.2s | Exploring helpers (not in v6.6.1's tool set) |
| `ha_get_overview` | 6.7s | Getting system overview |
| `ha_config_get_automation` | 3.4s | Verifying created automation |

Plus a wasted `ha_config_set_helper` attempt (5.3s) where master tried to update a non-existent entity before retrying as a create.

### Tool Description Difference

v6.6.1 Turn 1 input: 28,232 tokens. master Turn 1 input: 28,529 tokens. Delta: **+297 tokens (1.1%)** -- negligible.

### Assessment

| Factor | Contribution | Is this a code regression? |
|--------|-------------|--------------------------|
| KV-cache miss | 75% of slowdown | **No** -- Gemini-side caching behavior, not ha-mcp code |
| Extra exploration | 25% of slowdown | **No** -- agent chose a longer path due to broader tool set |
| Tool description size | <1% | **No** -- +297 tokens is noise-level |

**Verdict: NOT a regression.** The s02 slowdown is caused by Gemini's KV-cache invalidation (which happens nondeterministically based on response structure) and the agent choosing a more exploratory path with the broader master tool set. Both factors would likely differ on a re-run.

---

## Methodology

- **Runner**: `tests/uat/stories/run_story.py` (container-per-agent, one story at a time)
- **Container**: Home Assistant Docker test environment (fresh state per agent)
- **Agent**: Gemini CLI (`gemini -p <prompt> --approval-mode yolo`)
- **MCP server**: Local branch (master) or `uvx --from git+...@v6.6.1` for baseline
- **Token source**: Gemini session files (`~/.gemini/tmp/<hash>/chats/session-*.json`)
- **Tool sizes**: Measured via FastMCP in-memory client (`measure_tools.py`)
- **Billable tokens**: non-cached input + output + thoughts (cached tokens excluded)

### Story Catalog

| ID | Category | Weight | Description |
|----|----------|--------|-------------|
| s01 | automation | 5 | Sunset porch light |
| s02 | automation | 5 | Motion-activated kitchen light |
| s03 | troubleshoot | 5 | Diagnose non-triggering automation |
| s04 | dashboard | 4 | Create energy monitoring dashboard |
| s05 | entity | 4 | Find and rename entities |
| s06 | script | 4 | Create movie night script |
| s07 | automation | 4 | Delete an automation |
| s08 | automation | 4 | Time-based heating schedule |
| s09 | helper | 3 | Create counter and toggle helpers |
| s10 | organization | 3 | Organize entities into areas |
| s11 | troubleshoot | 3 | Deep search for device issues |
| s12 | organization | 3 | Create and apply labels |
